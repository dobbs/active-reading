<!doctype html>
<title>Branch</title>
<script type="module">
 const {log, auth, buttonTemplate, unauthTemplate, authTemplate} = window
 await import("/deps/localForage-1.10.0.js")
 const store = localforage.createInstance({
   name: "fifth-random",
   storeName: "proof"
 })
 main()
 async function main() {

   try {
     window.addEventListener("message", event => {
       const {origin, data} = event
       if (data.action != "registerCapabilities") return
       const {capabilities} = data
       console.log("registerCapabilities", capabilities)
     })

     let authUrl = await store.getItem("authUrl")
     if (!authUrl) {
       log.textContent += `arrived unauthenticated\n`
       showLoginButton()
     } else {
       log.textContent += `arrived authenticated\n`
       showAuthenticated(authUrl)
     }
   } catch (error) {
     window.log.textContent += `WAT? ${error}`
   }
 }
 function showLoginButton() {
   auth.innerHTML = ""
   auth.appendChild(buttonTemplate.content.cloneNode(true))
   auth.querySelector('button').onclick = showUnauthenticated
 }
 function showUnauthenticated(event) {
   auth.innerHTML = ""
   auth.appendChild(unauthTemplate.content.cloneNode(true))
   auth.querySelector('form').onsubmit = event => {
     event.preventDefault()
     const authUrl = event.target.url.value
     store.setItem("authUrl", authUrl)
     showAuthenticated(authUrl)
   }
 }
 function showAuthenticated(authUrl) {
   auth.innerHTML = ""
   const node = authTemplate.content.cloneNode(true)
   node.querySelector('iframe').setAttribute("src", authUrl)
   auth.appendChild(node)
 }
</script>

</script>
<div id="auth">
</div>
<pre id="log">
</pre>

<template id="buttonTemplate">
  <button>Login</button>
</template>

<template id="unauthTemplate">
  <form action="#">
    <label for="url">URL</label>
    <input name="url" type="text">
  </form>
</template>

<template id="authTemplate">
  <iframe name="reader" src=""
          sandbox="allow-same-origin allow-scripts allow-storage-access-by-user-activation"></iframe>
</template>
